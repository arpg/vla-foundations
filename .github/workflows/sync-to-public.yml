name: Sync to Public Repo

on:
  push:
    tags:
      - 'release-scratch-*'   # Trigger on release tags like release-scratch-1, release-scratch-2, etc.

jobs:
  sanitize-and-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper sync and linting
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # =====================================================================
      # PRE-SYNC VALIDATION (FAIL-SAFE)
      # =====================================================================

      - name: Validate Git History (Senior Staff Form)
        run: |
          echo "=== Validating Git History ==="

          # Check for merge commits (non-linear history)
          MERGE_COMMITS=$(git log --merges --oneline | head -5)
          if [ ! -z "$MERGE_COMMITS" ]; then
            echo "âš ï¸  Warning: Found merge commits (non-linear history):"
            echo "$MERGE_COMMITS"
            echo ""
            echo "Recommendation: Use rebase workflow for cleaner history"
          fi

          # Check recent commit messages for semantic structure
          echo ""
          echo "Recent commits:"
          git log --oneline -5

          # Check for conventional commit format
          NON_SEMANTIC=$(git log --oneline -10 | grep -v -E "^[a-f0-9]+ (feat|fix|docs|style|refactor|test|chore|perf)(\(.+\))?:" || true)
          if [ ! -z "$NON_SEMANTIC" ]; then
            echo ""
            echo "â„¹ï¸  Note: Some commits don't follow Conventional Commits format"
            echo "   Consider using: feat(), fix(), docs(), etc."
          fi

          echo ""
          echo "âœ… Git history validation complete"

      - name: Pre-Sanitization Linting
        run: |
          echo "=== Pre-Sanitization Linting ==="

          # Run sanitization in dry-run mode first (with fail-safe checks)
          echo "Running sanitization validation..."
          python3 scripts/_sanitize_todos.py || {
            echo "âŒ FAIL-SAFE: Sanitization pre-check failed!"
            echo "   Fix [SOLUTION] markers before creating release tag."
            exit 1
          }

          echo ""
          echo "âœ… Pre-sanitization linting passed"

      - name: Display repository state
        run: |
          echo "=== Repository State Before Sanitization ==="
          echo "Current branch/tag: $(git describe --tags --always)"
          echo "Private directories:"
          ls -la private/ 2>/dev/null || echo "  (not found)"
          ls -la tests/internal/ 2>/dev/null || echo "  (not found)"
          echo ""

      # =====================================================================
      # SANITIZATION PIPELINE
      # =====================================================================

      - name: Run sanitization script
        run: |
          echo "=== Running Sanitization Pipeline ==="
          bash scripts/sanitize.sh

      - name: Display repository state after sanitization
        run: |
          echo "=== Repository State After Sanitization ==="
          echo "Remaining files:"
          git status
          echo ""
          echo "Changed files:"
          git diff HEAD~1 --name-only || echo "(no previous commit)"
          echo ""

      # =====================================================================
      # POST-SANITIZATION VALIDATION (FAIL-SAFE)
      # =====================================================================

      - name: Post-Sanitization Leak Detection
        run: |
          echo "=== FAIL-SAFE: Checking for Solution Leaks ==="

          LEAK_FOUND=0

          # Check for TODO: [SOLUTION] comments
          echo "1. Checking for TODO: [SOLUTION] patterns..."
          if grep -r "TODO:.*\[SOLUTION\]" src/ content/ 2>/dev/null; then
            echo "âŒ ERROR: Found TODO: [SOLUTION] in sanitized code!"
            LEAK_FOUND=1
          else
            echo "   âœ“ No TODO: [SOLUTION] found"
          fi

          # Check for any [SOLUTION] markers
          echo ""
          echo "2. Checking for [SOLUTION] markers..."
          if grep -r "\[SOLUTION\]" src/ content/ 2>/dev/null; then
            echo "âŒ ERROR: Found [SOLUTION] markers in sanitized code!"
            LEAK_FOUND=1
          else
            echo "   âœ“ No [SOLUTION] markers found"
          fi

          # Check that private/ is gone
          echo ""
          echo "3. Verifying private/ removal..."
          if [ -d "private/" ]; then
            echo "âŒ ERROR: private/ directory still exists!"
            LEAK_FOUND=1
          else
            echo "   âœ“ private/ removed"
          fi

          # Check that tests/internal/ is gone
          echo ""
          echo "4. Verifying tests/internal/ removal..."
          if [ -d "tests/internal/" ]; then
            echo "âŒ ERROR: tests/internal/ directory still exists!"
            LEAK_FOUND=1
          else
            echo "   âœ“ tests/internal/ removed"
          fi

          # Check that solution management script is gone
          echo ""
          echo "5. Verifying manage_solutions.py removal..."
          if [ -f "scripts/manage_solutions.py" ]; then
            echo "âŒ ERROR: manage_solutions.py still exists!"
            LEAK_FOUND=1
          else
            echo "   âœ“ manage_solutions.py removed"
          fi

          # Check that dev scripts are gone
          echo ""
          echo "6. Verifying scripts/dev/ removal..."
          if [ -d "scripts/dev/" ]; then
            echo "âŒ ERROR: scripts/dev/ directory still exists!"
            LEAK_FOUND=1
          else
            echo "   âœ“ scripts/dev/ removed"
          fi

          echo ""
          if [ $LEAK_FOUND -eq 0 ]; then
            echo "âœ… LEAK DETECTION PASSED: Repository is clean"
          else
            echo "âŒ LEAK DETECTION FAILED: Solution content remains!"
            echo ""
            echo "ğŸš« ABORTING SYNC - Fix sanitization issues"
            exit 1
          fi

      # =====================================================================
      # PUSH TO PUBLIC REPOSITORY
      # =====================================================================

      - name: Push to public repo
        env:
          PUBLIC_REPO_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          echo "=== Pushing to Public Repository ==="

          # Configure git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Add public remote
          git remote add public https://x-access-token:${PUBLIC_REPO_TOKEN}@github.com/arpg/vla-foundations.git

          # Get the tag name
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "Syncing tag: $TAG_NAME"

          # Push to public repo on a release branch
          RELEASE_BRANCH="public-release-${TAG_NAME}"
          git checkout -b "$RELEASE_BRANCH"
          git push public "$RELEASE_BRANCH" --force

          echo ""
          echo "âœ… Synced to public repo (branch: $RELEASE_BRANCH)"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Next steps:"
          echo "  1. Review: https://github.com/arpg/vla-foundations/tree/$RELEASE_BRANCH"
          echo "  2. Create PR to merge $RELEASE_BRANCH â†’ main/staging"
          echo "  3. After review, merge PR to publish release"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
