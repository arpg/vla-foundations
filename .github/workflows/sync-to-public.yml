name: Sync to Public Repo

on:
  push:
    tags:
      - 'release-scratch-*'   # Trigger on release tags like release-scratch-1, release-scratch-2, etc.

jobs:
  sanitize-and-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper sync
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Display repository state
        run: |
          echo "=== Repository State Before Sanitization ==="
          echo "Current branch/tag: $(git describe --tags --always)"
          echo "Private directories:"
          ls -la private/ 2>/dev/null || echo "  (not found)"
          ls -la tests/internal/ 2>/dev/null || echo "  (not found)"
          echo ""

      - name: Run sanitization script
        run: |
          echo "Running sanitization..."
          bash scripts/sanitize.sh

      - name: Display repository state after sanitization
        run: |
          echo "=== Repository State After Sanitization ==="
          echo "Remaining files:"
          git status
          echo ""
          echo "Changed files:"
          git diff HEAD~1 --name-only || echo "(no previous commit)"
          echo ""

      - name: Dry run check for leaks
        run: |
          echo "=== Checking for Solution Leaks ==="

          # Check for TODO: [SOLUTION] comments
          if grep -r "TODO:.*\[SOLUTION\]" src/ content/ 2>/dev/null; then
            echo "❌ ERROR: Found TODO: [SOLUTION] in sanitized code!"
            exit 1
          fi

          # Check for inline [SOLUTION] comments
          if grep -r "\[SOLUTION\]" src/ content/ 2>/dev/null; then
            echo "❌ ERROR: Found [SOLUTION] markers in sanitized code!"
            exit 1
          fi

          # Check that private/ is gone
          if [ -d "private/" ]; then
            echo "❌ ERROR: private/ directory still exists!"
            exit 1
          fi

          # Check that tests/internal/ is gone
          if [ -d "tests/internal/" ]; then
            echo "❌ ERROR: tests/internal/ directory still exists!"
            exit 1
          fi

          # Check that solution management script is gone
          if [ -f "scripts/manage_solutions.py" ]; then
            echo "❌ ERROR: manage_solutions.py still exists!"
            exit 1
          fi

          echo "✅ Dry run passed: No solution leaks detected"

      - name: Push to public repo
        env:
          PUBLIC_REPO_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          # Configure git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Add public remote
          git remote add public https://x-access-token:${PUBLIC_REPO_TOKEN}@github.com/arpg/vla-foundations.git

          # Get the tag name
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "Syncing tag: $TAG_NAME"

          # Push to public repo on a release branch
          RELEASE_BRANCH="public-release-${TAG_NAME}"
          git checkout -b "$RELEASE_BRANCH"
          git push public "$RELEASE_BRANCH" --force

          echo "✅ Synced to public repo (branch: $RELEASE_BRANCH)"
          echo ""
          echo "Next steps:"
          echo "  1. Review the changes at: https://github.com/arpg/vla-foundations/tree/$RELEASE_BRANCH"
          echo "  2. Create a PR to merge $RELEASE_BRANCH into main/staging"
          echo "  3. After review, merge the PR to publish the release"
