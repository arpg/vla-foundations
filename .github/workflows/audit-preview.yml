name: Audit Preview Comment

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'content/textbook/audits/staging/**.mdx'

jobs:
  comment:
    runs-on: ubuntu-latest
    steps:
      - name: Extract audit filename
        id: audit
        run: |
          FILES=$(gh pr view ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --json files --jq '.files[].path' | grep 'content/textbook/audits/staging/.*\.mdx$' || echo "")
          if [ -n "$FILES" ]; then
            FILENAME=$(echo "$FILES" | head -1 | sed 's/content\/textbook\/audits\/staging\///' | sed 's/\.mdx$//')
            echo "filename=$FILENAME" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment PR with preview link
        if: steps.audit.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const filename = '${{ steps.audit.outputs.filename }}';
            const prNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            const branch = context.payload.pull_request.head.ref;
            
            const previewUrl = `https://vla-foundations-git-${{branch}}-${{owner}}.vercel.app/textbook/audits/staging/${{filename}}`;
            
            const comment = `## ðŸ” Paper Audit Preview
            
Your audit is ready for review! View the rendered version here:
            
ðŸ”— **Preview URL:** ${{previewUrl}}
            
### Review Checklist
- [ ] LaTeX equations render correctly
- [ ] All sections are complete
- [ ] References are formatted properly
- [ ] Figures/diagrams display correctly
            
### Next Steps
1. Review your rendered audit using the preview link above
2. Tag @crheckman when ready for instructor review
3. Address any feedback and push updates (preview will auto-update)
            
---
*Note: This preview is only visible in preview deployments and will not appear in production until merged to main.*`;
            
            const {{ data: comments }} = await github.rest.issues.listComments({{
              owner,
              repo,
              issue_number: prNumber,
            }});
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('Paper Audit Preview')
            );
            
            if (botComment) {{
              await github.rest.issues.updateComment({{
                owner,
                repo,
                comment_id: botComment.id,
                body: comment
              }});
            }} else {{
              await github.rest.issues.createComment({{
                owner,
                repo,
                issue_number: prNumber,
                body: comment
              }});
            }}
