name: VLA Content Audit
on:
  pull_request:
    branches: [ staging, main ]

permissions:
  contents: write
  pull-requests: write

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - run: pnpm install

      - name: Standards Linter
        id: linter
        run: python3 scripts/audit_linter.py
        continue-on-error: true

      - name: Comment on Linter Failure
        if: steps.linter.outcome == 'failure'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ## ‚ùå Engineering Standards Check Failed

            Your audit does not meet the required "Senior Staff" engineering standards. Please address the following issues before requesting instructor review:

            ### Common Issues:

            **1. Semantic Line Breaks**
            - Each sentence should be on its own line
            - This makes PR commenting and reviewing much easier
            - Example:
              ```diff
              - This is a very long sentence with multiple ideas. It continues on the same line. This makes PR review difficult.
              + This is a sentence on its own line.
              + Each idea gets its own line.
              + This makes PR review much easier.
              ```

            **2. Clean Git History**
            - No "Merge branch 'main'" commits allowed
            - Use `git rebase main` instead of `git merge main`
            - Keep your commit history linear and clean

            ### How to Fix:

            **For semantic line breaks:**
            1. Edit your MDX file to put each sentence on a new line
            2. Commit and push the changes

            **For git history:**
            1. Run: `git rebase main` (or `git rebase staging`)
            2. Resolve any conflicts if needed
            3. Run: `git push --force-with-lease`

            ---
            *The linter will run automatically on your next push. Once all checks pass, your preview will deploy.*

      - name: Fail Build if Linter Failed
        if: steps.linter.outcome == 'failure'
        run: exit 1

      - name: Build with PR Preview
        env:
          STAGING_PR_NUMBER: ${{ github.event.pull_request.number }}
        run: pnpm build

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: out
          target-folder: staging/pulls/${{ github.event.pull_request.number }}
          clean: false

      - name: Comment PR with Preview Link
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            üöÄ **Audit Rendered**

            Your paper audit preview is ready for review!

            üîó **Preview URL:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/staging/pulls/${{ github.event.pull_request.number }}/textbook/audits/staging/

            ### Review Checklist
            - [ ] LaTeX equations render correctly
            - [ ] All sections are complete per the template
            - [ ] References are formatted properly
            - [ ] Figures/diagrams display correctly

            ### Next Steps
            1. Review your rendered audit using the preview link above
            2. Tag @crheckman when ready for instructor review
            3. Push updates to auto-refresh the preview

            ---
            *This preview will be removed when the PR is closed.*
